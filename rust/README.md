# Linear Subproblem Solutions (Rust)

## Usage

1. Clone the rust directory

2. Add the following to your project's `Cargo.toml`

    ```conf
    [dependencies.linear-subproblem-solutions-rust]
        path = ".../linear-subproblem-solutions/rust"
    ```

3. Add to your source files where needed

    ```rust
    use linear_subproblem_solutions_rust as subproblems;
    use subproblems::nalgebra as na;
    ```

### Running the Demo

See demo.rs for example usage.

```
cargo run
```

### Testing

#### Correctness Tests

```
cargo test correctness --release
```

For diagnostic info:

```
cargo test correctness --release -- --nocapture
```

#### Timing Tests

```
cargo test timing --release -- --nocapture --test-threads 1
```

Make sure to create a directory callled `data` in the root directory with a subdirectory `data/out`. Place the input CSV files into `data`. They should be generated by the following files:

```
matlab/timing_tests/generate_input_CSV.m
matlab/timing_tests/generate_robot_input_CSV.m
matlab/timing_tests/generate_hardcoded_input_CSV.m
```

The subproblem files should be named like `Subproblem_X.csv`.

The inverse kinematics filenames are

```
IkGenSixDof.csv
IkSpherical.csv
IkSphericalTwoIntersecting.csv
IkSphericalTwoParallel.csv
IkThreeParallel.csv
IkThreeParallelTwoIntersecting.csv
IkTwoIntersecting.csv
IkTwoParallel.csv
```

The hardcoded filenames are

```
HcIRB6640.csv
HcKUKAR800FixedQ3.csv
HcRRCFixedQ6.csv
HcSphericalBot.csv
HcThreeParallelBot.csv
HcTwoParallelBot.csv
HcUR5.csv
HcYumiFixedQ3.csv
```

### Benchmarking

```
cargo bench
```

### Linking ikfast

1. Compile the generated file into a static library with `ikfast_proxy.cpp` and place it into a folder called `lib_ikfast` in the project directory.

    Example compilation for the msvc toolchain:

    ```
    cl /O2 /c /EHsc /Folib_ikfast/[NAME].obj /DIKFAST_NO_MAIN .../[NAME].cpp
    cl /O2 /c /EHsc /Folib_ikfast/ikfast_proxy.obj ikfast/ikfast_proxy.cpp
    lib lib_ikfast/[NAME].obj lib_ikfast/ikfast_proxy.obj /out:lib_ikfast/[NAME].lib
    ```

    Compilation for the gnu toolchain:
    ```
    g++ -O3 -o lib_ikfast/ikfast_proxy.obj ikfast/ikfast_proxy.cpp -c

    g++ -O3 -o lib_ikfast/IRB6640.obj -DIKFAST_NO_MAIN ../ikfast/generated/IRB_6640.cpp -c
    ar rcs lib_ikfast/libIRB6640.a lib_ikfast/IRB6640.obj lib_ikfast/ikfast_proxy.obj

    g++ -O3 -o lib_ikfast/SphericalBot.obj -DIKFAST_NO_MAIN ../ikfast/generated/spherical_bot.cpp -c
    ar rcs lib_ikfast/libSphericalBot.a lib_ikfast/SphericalBot.obj lib_ikfast/ikfast_proxy.obj

    g++ -O3 -o lib_ikfast/UR5.obj -DIKFAST_NO_MAIN ../ikfast/generated/ur5.cpp -llapack -c
    ar rcs lib_ikfast/libUR5.a lib_ikfast/UR5.obj lib_ikfast/ikfast_proxy.obj
    ```
    Make sure IKFAST_NO_MAIN is defined.

2. Create a file in the project directory called `lib_ikfast.config` and place the following contents into it.

    ```
    active = true
    link_lib = spherical_bot
    kinematics_h = -1*k, -1*j, -1*j, -1*i, -1*j, -1*i
    kinematics_p = 0, 0.35*i + 0.815*k, 1.2*k, 0.145*k + 1.545*i, 0, 0, 0.158*i
    ```

    `active` specifies whether or not to link.

    `link_lib` specifies the name of the library to link.

    `kinematics_*` is used to specify the kinematic parameters of the robot.
